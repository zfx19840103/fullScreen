"use strict";let e,t;Object.defineProperty(exports,"__esModule",{value:!0});var i=require("node:fs/promises"),n=require("fs"),o=require("os"),r=require("path"),s=require("@rollup/pluginutils"),a=require("zlib"),l=require("util");function c(e){return e.length}function u(e,t){let i="function"==typeof t?t(e):t,{dir:n,base:o}=r.parse(e);return i.replace(/\[path\]/,n?n+"/":"").replace(/\[base\]/,o)}function d(e){return/^\\\\\?\\/.test(e)?e:e.replace(/\\/g,"/")}async function h(e){let t=await Promise.all((await i.readdir(e)).map(t=>r.join(e,t))),n=0,o=[];for(;n!==c(t);){let e=t[n],s=await i.stat(e);if(s.isDirectory()){let n=await i.readdir(e);t.push(...n.map(t=>r.join(e,t)))}s.isFile()&&o.push(e),n++}return o}function p(t){return"string"==typeof t?(e||(e=new TextEncoder),e.encode(t)):t}function f(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}const w={AREG_TYPE:"\0",DIR_TYPE:"5"},g={encode:e=>(t||(t=new TextEncoder),t.encode(e))},b={encode:(e,t)=>{let i=e.toString(8);return t?c(i)<=t?"0".repeat(t-c(i))+i+" ":"7".repeat(t)+" ":i}};class y{encode(){let e="",{typeflag:t,linkname:i,mode:n,uid:o,gid:r,size:s,mtime:a,uname:l,gname:u,devmajor:d,devminor:h}=this.options,p=this.options.name;t===w.DIR_TYPE&&"/"!==p[c(p)-1]&&(p+="/");let f=g.encode(p);if(f.length!==p.length)return null;for(;p.length>100;){let t=p.indexOf("/");if(-1===t)return null;let i=p.slice(0,t);e+=e?"/"+i:i,p=p.slice(t+1)}if(f.length!==p.length&&(f=g.encode(p)),f.length+e.length>255||i&&g.encode(i).length>100)return null;if(this.block.set(f,0),this.block.set(g.encode(b.encode(n,6)),100),this.block.set(g.encode(b.encode(o,6)),108),this.block.set(g.encode(b.encode(r,6)),116),b.encode(s).length>11){let e=s,t=[];for(let i=11;i>0;i--)t[11-i]=255&e,e=Math.floor(e/256);t.unshift(128),this.block.set(new Uint8Array(t),124)}else this.block.set(g.encode(b.encode(s,11)),124);this.block.set(g.encode(b.encode(a,11)),136),this.block.set(g.encode(0+t),156),i&&this.block.set(g.encode(i),157),this.block.set(g.encode("ustar"),257),this.block.set(g.encode("00"),263),l&&this.block.set(g.encode(l),265),u&&this.block.set(g.encode(u),297),this.block.set(g.encode(b.encode(d,6)),329),this.block.set(g.encode(b.encode(h,6)),337),e&&this.block.set(g.encode(e),345);let y=0;for(let e=0;e<this.block.length;e++)e>=148&&e<156?y+=32:y+=this.block[e];this.block.set(g.encode(b.encode(y,6)),148)}get data(){return this.block}constructor(e){f(this,"options",void 0),f(this,"block",void 0),this.options=e,this.block=new Uint8Array(512)}}class m{add(e){this.files.push(e)}write(){let e=[];for(let t of this.files){let i=new y({name:t.filename,typeflag:w.AREG_TYPE,mode:420,uid:0,gid:0,devmajor:0,devminor:0,size:t.content.length,mtime:Math.floor(Date.now()/1e3)});i.encode(),e.push(i.data),e.push(t.content);let n=new Uint8Array((512-t.content.length%512)%512);e.push(n)}return e.push(new Uint8Array(512)),e.push(new Uint8Array(512)),new Uint8Array(e.reduce((e,t)=>e.concat(Array.from(t)),[]))}constructor(){f(this,"files",void 0),this.files=[]}}async function v(e,t,i){try{return await t(e,i)}catch(e){return Promise.reject(e)}}const O={gzip:{level:a.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[a.constants.BROTLI_PARAM_QUALITY]:a.constants.BROTLI_MAX_QUALITY}},deflate:{level:a.constants.Z_BEST_COMPRESSION},deflateRaw:{level:a.constants.Z_BEST_COMPRESSION}};function k(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class P{enqueue(e){this.queue.push(e),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let e=this.queue.shift();this.running++;try{await e()}catch(e){this.errors.push(e)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(e=>setTimeout(e,0));if(c(this.errors))throw AggregateError(this.errors,"task failed")}constructor(e){k(this,"maxConcurrent",void 0),k(this,"queue",void 0),k(this,"running",void 0),k(this,"errors",void 0),this.maxConcurrent=e,this.queue=[],this.errors=[],this.running=0}}const j="vite:build-import-analysis",A="vite-plugin-compression",E=(()=>{let e=o.cpus()||{length:1};return 1===e.length?10:Math.max(1,e.length-1)})();function q(e){var t;let i=new Set,n=(e,t)=>d(r.resolve(e,t));return(null===(t=e.build.rollupOptions)||void 0===t?void 0:t.output)?(Array.isArray(e.build.rollupOptions.output)?e.build.rollupOptions.output:[e.build.rollupOptions.output]).forEach(t=>{("object"!=typeof t||c(Object.keys(t)))&&i.add(n(e.root,t.dir||e.build.outDir))}):i.add(n(e.root,e.build.outDir)),i}async function _(e,t){let i=e.generateBundle;if("object"==typeof i&&i.handler){let e=i.handler;i.handler=async function(...i){await e.apply(this,i),await t.apply(this,i)}}"function"==typeof i&&(e.generateBundle=async function(...e){await i.apply(this,e),await t.apply(this,e)})}async function R(e,t){let i=!("copyPublicDir"in e.build)||e.build.copyPublicDir;if(e.publicDir&&i&&n.existsSync(e.publicDir)){let i=await h(e.publicDir),n=r.join(e.root,r.relative(e.root,e.publicDir));await Promise.all(i.map(async e=>{let i=d(r.relative(n,e));await t(i,e)}))}}function T(e={}){let{include:t=/\.(html|xml|css|json|js|mjs|svg)$/,exclude:n,threshold:o=0,algorithm:d="gzip",filename:h,compressionOptions:f,deleteOriginalAssets:w=!1,skipIfLargerOrEqual:g=!0}=e,b=s.createFilter(t,n),y=[],m=[],k=Object.create(null);k.algorithm="string"==typeof d?function(e){let t=e in a?e:"gzip";return{algorithm:l.promisify(a[t])}}(d).algorithm:d,k.options="function"==typeof d?f:Object.assign(O[d],f),k.filename=null!=h?h:"brotliCompress"===d?"[path][base].br":"[path][base].gz";let x=new P(E),S=async function(e,t){for(let e in t){if(!b(e))continue;let i=t[e],n=p("asset"===i.type?i.source:i.code),r=c(n);r<o||x.enqueue(async()=>{let i=u(e,k.filename),o=await v(n,k.algorithm,k.options);g&&c(o)>=r||((w||e===i)&&Reflect.deleteProperty(t,e),this.emitFile({type:"asset",fileName:i,source:o}))})}await x.wait().catch(this.error)},D={staticOutputs:new Set};return{name:A,apply:"build",enforce:"post",api:D,async configResolved(e){m.push(...q(e)),await R(e,async e=>{y.push(e)});let t=e.plugins.find(e=>e.name===j);if(!t)throw Error("vite-plugin-compression can't be work in versions lower than vite2.0.0");_(t,S)},async closeBundle(){for(let e of m)for(let t of y)x.enqueue(async()=>{let n=r.join(e,t);if(b(n)||D.staticOutputs.has(t)){let{size:s}=await i.stat(n);if(s<o)D.staticOutputs.has(t)||D.staticOutputs.add(t);else{let o=await i.readFile(n),s=await v(o,k.algorithm,k.options);if(g&&c(s)>=c(o))return;let a=u(t,k.filename);D.staticOutputs.has(a)||D.staticOutputs.add(a);let l=r.join(e,a);w&&l!==n&&await i.rm(n,{recursive:!0,force:!0}),await i.writeFile(l,s)}}else D.staticOutputs.add(t)});await x.wait().catch(e=>e)}}}T.getPluginAPI=e=>{var t;return null===(t=e.find(e=>e.name===A))||void 0===t?void 0:t.api},exports.compression=T,exports.default=T,exports.tarball=function(e={}){let t;let{dest:n}=e,o=[],s=[],a=[],l=process.cwd(),c=function(){let e=new m,t={dests:[],root:""};return{add:t=>{e.add({filename:t.filename,content:p(t.content)})},write:async()=>{let n=e.write();await Promise.all(t.dests.map(async e=>{let o=d(r.resolve(t.root,e+".tar")),s=d(r.dirname(o));t.root!==s&&await i.mkdir(s,{recursive:!0}),await i.writeFile(o,n)}))},setOptions:e=>Object.assign(t,e)}}(),u=new P(E);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(e){if(s.push(...q(e)),l=e.root,a=n?[n]:s,c.setOptions({dests:a,root:l}),(t=T.getPluginAPI(e.plugins))||await R(e,async e=>{o.push(e)}),!e.plugins.find(e=>e.name===j))throw Error("vite-plugin-cp can't be work in versions lower than vite2.0.0")},async writeBundle(e,t){for(let e in t){let i=t[e];c.add({filename:e,content:"asset"===i.type?i.source:i.code})}},async closeBundle(){for(let e of(!o.length&&t&&t.staticOutputs&&o.push(...t.staticOutputs),s))for(let t of o)u.enqueue(async()=>{let n=r.join(e,t),o=await i.readFile(n);c.add({filename:t,content:o})});await u.wait(),await c.write()}}};
