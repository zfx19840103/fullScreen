let t,e;import i from"node:fs/promises";import n from"fs";import o from"os";import r from"path";import{createFilter as s}from"@rollup/pluginutils";import a from"zlib";import l from"util";function c(t){return t.length}function u(t,e){let i="function"==typeof e?e(t):e,{dir:n,base:o}=r.parse(t);return i.replace(/\[path\]/,n?n+"/":"").replace(/\[base\]/,o)}function p(t){return/^\\\\\?\\/.test(t)?t:t.replace(/\\/g,"/")}async function h(t){let e=await Promise.all((await i.readdir(t)).map(e=>r.join(t,e))),n=0,o=[];for(;n!==c(e);){let t=e[n],s=await i.stat(t);if(s.isDirectory()){let n=await i.readdir(t);e.push(...n.map(e=>r.join(t,e)))}s.isFile()&&o.push(t),n++}return o}function d(e){return"string"==typeof e?(t||(t=new TextEncoder),t.encode(e)):e}function f(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}let m={AREG_TYPE:"\0",DIR_TYPE:"5"},w={encode:t=>(e||(e=new TextEncoder),e.encode(t))},g={encode:(t,e)=>{let i=t.toString(8);return e?c(i)<=e?"0".repeat(e-c(i))+i+" ":"7".repeat(e)+" ":i}};class b{encode(){let t="",{typeflag:e,linkname:i,mode:n,uid:o,gid:r,size:s,mtime:a,uname:l,gname:u,devmajor:p,devminor:h}=this.options,d=this.options.name;e===m.DIR_TYPE&&"/"!==d[c(d)-1]&&(d+="/");let f=w.encode(d);if(f.length!==d.length)return null;for(;d.length>100;){let e=d.indexOf("/");if(-1===e)return null;let i=d.slice(0,e);t+=t?"/"+i:i,d=d.slice(e+1)}if(f.length!==d.length&&(f=w.encode(d)),f.length+t.length>255||i&&w.encode(i).length>100)return null;if(this.block.set(f,0),this.block.set(w.encode(g.encode(n,6)),100),this.block.set(w.encode(g.encode(o,6)),108),this.block.set(w.encode(g.encode(r,6)),116),g.encode(s).length>11){let t=s,e=[];for(let i=11;i>0;i--)e[11-i]=255&t,t=Math.floor(t/256);e.unshift(128),this.block.set(new Uint8Array(e),124)}else this.block.set(w.encode(g.encode(s,11)),124);this.block.set(w.encode(g.encode(a,11)),136),this.block.set(w.encode(0+e),156),i&&this.block.set(w.encode(i),157),this.block.set(w.encode("ustar"),257),this.block.set(w.encode("00"),263),l&&this.block.set(w.encode(l),265),u&&this.block.set(w.encode(u),297),this.block.set(w.encode(g.encode(p,6)),329),this.block.set(w.encode(g.encode(h,6)),337),t&&this.block.set(w.encode(t),345);let b=0;for(let t=0;t<this.block.length;t++)t>=148&&t<156?b+=32:b+=this.block[t];this.block.set(w.encode(g.encode(b,6)),148)}get data(){return this.block}constructor(t){f(this,"options",void 0),f(this,"block",void 0),this.options=t,this.block=new Uint8Array(512)}}class y{add(t){this.files.push(t)}write(){let t=[];for(let e of this.files){let i=new b({name:e.filename,typeflag:m.AREG_TYPE,mode:420,uid:0,gid:0,devmajor:0,devminor:0,size:e.content.length,mtime:Math.floor(Date.now()/1e3)});i.encode(),t.push(i.data),t.push(e.content);let n=new Uint8Array((512-e.content.length%512)%512);t.push(n)}return t.push(new Uint8Array(512)),t.push(new Uint8Array(512)),new Uint8Array(t.reduce((t,e)=>t.concat(Array.from(e)),[]))}constructor(){f(this,"files",void 0),this.files=[]}}async function v(t,e,i){try{return await e(t,i)}catch(t){return Promise.reject(t)}}let O={gzip:{level:a.constants.Z_BEST_COMPRESSION},brotliCompress:{params:{[a.constants.BROTLI_PARAM_QUALITY]:a.constants.BROTLI_MAX_QUALITY}},deflate:{level:a.constants.Z_BEST_COMPRESSION},deflateRaw:{level:a.constants.Z_BEST_COMPRESSION}};function k(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}class P{enqueue(t){this.queue.push(t),this.run()}async run(){for(;this.running<this.maxConcurrent&&this.queue.length;){let t=this.queue.shift();this.running++;try{await t()}catch(t){this.errors.push(t)}finally{this.running--,this.run()}}}async wait(){for(;this.running;)await new Promise(t=>setTimeout(t,0));if(c(this.errors))throw AggregateError(this.errors,"task failed")}constructor(t){k(this,"maxConcurrent",void 0),k(this,"queue",void 0),k(this,"running",void 0),k(this,"errors",void 0),this.maxConcurrent=t,this.queue=[],this.errors=[],this.running=0}}let j="vite:build-import-analysis",A="vite-plugin-compression",E=(()=>{let t=o.cpus()||{length:1};return 1===t.length?10:Math.max(1,t.length-1)})();function R(t){var e;let i=new Set,n=(t,e)=>p(r.resolve(t,e));return(null===(e=t.build.rollupOptions)||void 0===e?void 0:e.output)?(Array.isArray(t.build.rollupOptions.output)?t.build.rollupOptions.output:[t.build.rollupOptions.output]).forEach(e=>{("object"!=typeof e||c(Object.keys(e)))&&i.add(n(t.root,e.dir||t.build.outDir))}):i.add(n(t.root,t.build.outDir)),i}async function T(t,e){let i=t.generateBundle;if("object"==typeof i&&i.handler){let t=i.handler;i.handler=async function(...i){await t.apply(this,i),await e.apply(this,i)}}"function"==typeof i&&(t.generateBundle=async function(...t){await i.apply(this,t),await e.apply(this,t)})}async function _(t,e){let i=!("copyPublicDir"in t.build)||t.build.copyPublicDir;if(t.publicDir&&i&&n.existsSync(t.publicDir)){let i=await h(t.publicDir),n=r.join(t.root,r.relative(t.root,t.publicDir));await Promise.all(i.map(async t=>{let i=p(r.relative(n,t));await e(i,t)}))}}function S(t={}){let e;let{dest:n}=t,o=[],s=[],a=[],l=process.cwd(),c=function(){let t=new y,e={dests:[],root:""};return{add:e=>{t.add({filename:e.filename,content:d(e.content)})},write:async()=>{let n=t.write();await Promise.all(e.dests.map(async t=>{let o=p(r.resolve(e.root,t+".tar")),s=p(r.dirname(o));e.root!==s&&await i.mkdir(s,{recursive:!0}),await i.writeFile(o,n)}))},setOptions:t=>Object.assign(e,t)}}(),u=new P(E);return{name:"vite-plugin-tarball",enforce:"post",async configResolved(t){if(s.push(...R(t)),l=t.root,a=n?[n]:s,c.setOptions({dests:a,root:l}),(e=D.getPluginAPI(t.plugins))||await _(t,async t=>{o.push(t)}),!t.plugins.find(t=>t.name===j))throw Error("vite-plugin-cp can't be work in versions lower than vite2.0.0")},async writeBundle(t,e){for(let t in e){let i=e[t];c.add({filename:t,content:"asset"===i.type?i.source:i.code})}},async closeBundle(){for(let t of(!o.length&&e&&e.staticOutputs&&o.push(...e.staticOutputs),s))for(let e of o)u.enqueue(async()=>{let n=r.join(t,e),o=await i.readFile(n);c.add({filename:e,content:o})});await u.wait(),await c.write()}}}function D(t={}){let{include:e=/\.(html|xml|css|json|js|mjs|svg)$/,exclude:n,threshold:o=0,algorithm:p="gzip",filename:h,compressionOptions:f,deleteOriginalAssets:m=!1,skipIfLargerOrEqual:w=!0}=t,g=s(e,n),b=[],y=[],k=Object.create(null);k.algorithm="string"==typeof p?function(t){let e=t in a?t:"gzip";return{algorithm:l.promisify(a[e])}}(p).algorithm:p,k.options="function"==typeof p?f:Object.assign(O[p],f),k.filename=null!=h?h:"brotliCompress"===p?"[path][base].br":"[path][base].gz";let S=new P(E),I=async function(t,e){for(let t in e){if(!g(t))continue;let i=e[t],n=d("asset"===i.type?i.source:i.code),r=c(n);r<o||S.enqueue(async()=>{let i=u(t,k.filename),o=await v(n,k.algorithm,k.options);w&&c(o)>=r||((m||t===i)&&Reflect.deleteProperty(e,t),this.emitFile({type:"asset",fileName:i,source:o}))})}await S.wait().catch(this.error)},x={staticOutputs:new Set};return{name:A,apply:"build",enforce:"post",api:x,async configResolved(t){y.push(...R(t)),await _(t,async t=>{b.push(t)});let e=t.plugins.find(t=>t.name===j);if(!e)throw Error("vite-plugin-compression can't be work in versions lower than vite2.0.0");T(e,I)},async closeBundle(){for(let t of y)for(let e of b)S.enqueue(async()=>{let n=r.join(t,e);if(g(n)||x.staticOutputs.has(e)){let{size:s}=await i.stat(n);if(s<o)x.staticOutputs.has(e)||x.staticOutputs.add(e);else{let o=await i.readFile(n),s=await v(o,k.algorithm,k.options);if(w&&c(s)>=c(o))return;let a=u(e,k.filename);x.staticOutputs.has(a)||x.staticOutputs.add(a);let l=r.join(t,a);m&&l!==n&&await i.rm(n,{recursive:!0,force:!0}),await i.writeFile(l,s)}}else x.staticOutputs.add(e)});await S.wait().catch(t=>t)}}}D.getPluginAPI=t=>{var e;return null===(e=t.find(t=>t.name===A))||void 0===e?void 0:e.api};export{D as compression,D as default,S as tarball};
